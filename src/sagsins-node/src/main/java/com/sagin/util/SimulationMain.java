package com.sagin.util;

import com.sagin.model.NodeInfo;
import com.sagin.model.NodeType;
import com.sagin.network.implement.NodeGateway;
import com.sagin.network.implement.TCP_Service;
import com.sagin.repository.INodeRepository;
import com.sagin.repository.IUserRepository;
import com.sagin.repository.MongoNodeRepository;
import com.sagin.repository.MongoUserRepository;
import com.sagin.routing.DynamicRoutingService;
import com.sagin.service.INodeService;
import com.sagin.service.NodeService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.stream.Collectors;

public class SimulationMain {

    private static final Logger logger = LoggerFactory.getLogger(SimulationMain.class);

    public static void main(String[] args) {
        if (args.length == 0) {
            System.err.println("C√∫ ph√°p: java com.sagin.util.SimulationMain <NODE_TYPE>");
            System.err.println("V√≠ d·ª•: java com.sagin.util.SimulationMain LEO_SATELLITE");
            return;
        }

        NodeType typeToRun;
        try {
            typeToRun = NodeType.fromString(args[0]);
        } catch (IllegalArgumentException e) {
            System.err.println("Lo·∫°i node kh√¥ng h·ª£p l·ªá: " + args[0]);
            System.err.println("C√°c lo·∫°i h·ª£p l·ªá: GROUND_STATION, LEO_SATELLITE, MEO_SATELLITE, GEO_SATELLITE");
            return;
        }

        INodeRepository nodeRepository = new MongoNodeRepository();
        IUserRepository userRepository = new MongoUserRepository();
        INodeService nodeService = new NodeService(nodeRepository);
        DynamicRoutingService routingService = new DynamicRoutingService(nodeRepository, nodeService);

        logger.info("Kh·ªüi ch·∫°y m√¥ ph·ªèng cho lo·∫°i node: {}", typeToRun);

        List<NodeInfo> nodesToRun = nodeRepository.getAllNodes().stream()
                .filter(n -> n.getNodeType() == typeToRun)
                .collect(Collectors.toList());

        if (nodesToRun.isEmpty()) {
            logger.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y node n√†o c√≥ type: {}", typeToRun);
            return;
        }

        logger.info("üîß S·ªë l∆∞·ª£ng node c·∫ßn ch·∫°y: {}", nodesToRun.size());

        for (NodeInfo nodeInfo : nodesToRun) {
            TCP_Service tcpService = new TCP_Service(nodeRepository, nodeService, userRepository, routingService);
            NodeGateway nodeGateway = new NodeGateway(tcpService);

            new Thread(() -> {
                nodeGateway.startListening(nodeInfo, nodeInfo.getCommunication().port());
                logger.info("Node Gateway started for node: {}", nodeInfo.getNodeId());
                try {
                    Thread.currentThread().join();
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    logger.warn("Node {} listener interrupted", nodeInfo.getNodeId(), e);
                }
            }, "Thread-" + nodeInfo.getNodeId()).start();
        }

        // Shutdown hook
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            logger.info("Shutting down all NodeGateways...");
            routingService.shutdown();
        }));

        routingService.forceUpdateRoutingTables();
        logger.info("Initial routing tables updated");
    }
}
